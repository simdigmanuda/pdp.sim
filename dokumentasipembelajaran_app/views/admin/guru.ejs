<!DOCTYPE html>
<html lang="id"><head><meta charset="UTF-8"><title>Data Guru</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/assets/admin.css">
  <script src="/assets/admin.js" defer></script>
</head>
<body class="dashboard-simple">
  <div class="layout">
    <%- include('_sidebar') %>
    <main class="content">
      <div class="main-top"><a class="pill-link" href="/admin/logout">Keluar</a></div>
      <h2>Data Guru</h2>

      <style>
        /* Modal Tambah Guru mengikuti gaya Tambah Alokasi */
        .form-box { max-width: 620px; margin: 0 auto 16px; }
        .form-grid { display: grid; grid-template-columns: 160px 1fr; column-gap: 16px; row-gap: 12px; align-items: center; }
        .form-grid label { margin: 0; font-weight: 700; font-size: 13px; color: #374151; }
        .form-grid .input-el input, .form-grid .input-el select { width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 10px; background: #fafafa; box-sizing: border-box; }
        .form-grid .input-el input:focus, .form-grid .input-el select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37,99,235,0.15); background: #fff; }
        .modal-backdrop-guru { position: fixed; inset: 0; background: rgba(17,24,39,0.35); display: flex; align-items: flex-start; justify-content: center; padding: 48px 16px; z-index: 50; }
        .modal-dialog-guru { width: 100%; max-width: 620px; }
        .modal-dialog-guru .card { overflow: hidden; }
        .modal-actions { display:flex; gap:8px; align-items:center; justify-content:flex-end; margin-top:12px; }
        .hidden { display: none; }

        @media (max-width: 520px) {
          .form-grid { grid-template-columns: 1fr; row-gap: 10px; }
          .form-grid label { margin-bottom: 4px; }
        }
      </style>

      <div id="guruModal" class="modal-backdrop-guru hidden" aria-hidden="true">
        <div class="modal-dialog-guru">
          <div class="card form-box">
            <form method="post" action="/admin/guru/add" class="form-guru">
              <div class="form-grid">
                <label for="guruNama">Nama</label>
                <div class="input-el"><input id="guruNama" type="text" name="nama" required placeholder="Nama guru"></div>

                <label for="guruEmail">Email</label>
                <div class="input-el"><input id="guruEmail" type="email" name="email" placeholder="opsional"></div>
              </div>
              <div class="modal-actions">
                <button type="submit">Tambah Guru</button>
                <a href="#" class="pill-link" data-modal-close>Batal</a>
              </div>
            </form>
          </div>
        </div>
      </div>

      <form method="post" action="/admin/guru/import" enctype="multipart/form-data" style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin:10px 0 14px;">
        <label style="color:#374151; font-weight:600; display:flex; align-items:center; gap:8px; margin:0;">
          Impor CSV Guru:
          <input type="file" name="file" accept=".csv,text/csv" style="border:1px solid #d1d5db; border-radius:6px; background:#fff; vertical-align:middle;">
        </label>
        <button type="submit" style="background:#257E62; color:#fff; border:none; padding:8px 12px; border-radius:999px; cursor:pointer; box-shadow:0 8px 18px rgba(37,126,98,.35);">Impor</button>
        <a class="pill-link" href="/assets/template_guru.csv" download="template_guru.csv">Unduh Template</a>
      </form>

      <form method="post" action="/admin/guru/add" style="margin-bottom:12px; display:none;">
        <label>Nama: <input type="text" name="nama" required></label>
        <label>Email: <input type="email" name="email" placeholder="opsional"></label>
        <button type="submit">Tambah Guru</button>
      </form>

      <div class="header-actions" style="margin:10px 0 14px; display:flex; align-items:center; gap:10px; justify-content:space-between; flex-wrap:wrap;">
        <div style="display:flex; align-items:center; gap:8px; color:#4b5563;">
          <button type="button" id="toggleGuruFormBtn" class="pill-link">Tambah Guru</button>
          <label>Tampilkan:
            <select id="limitSelectGuru" style="padding:6px 8px; border:1px solid #d1d5db; border-radius:6px;">
              <option value="10" <%= (typeof limit !== 'undefined' ? String(limit)==='10' : true) ? 'selected' : '' %>>10</option>
              <option value="50" <%= (typeof limit !== 'undefined' ? String(limit)==='50' : false) ? 'selected' : '' %>>50</option>
              <option value="100" <%= (typeof limit !== 'undefined' ? String(limit)==='100' : false) ? 'selected' : '' %>>100</option>
              <option value="1000" <%= (typeof limit !== 'undefined' ? String(limit)==='1000' : false) ? 'selected' : '' %>>1000</option>
            </select>
          </label>
        </div>
        <form method="get" style="display:flex; gap:8px; align-items:center; flex:1; justify-content:flex-end;">
          <input type="text" name="q" value="<%= typeof q !== 'undefined' ? q : '' %>" placeholder="Cari nama/email" style="padding:8px 10px; border:1px solid #d1d5db; border-radius:6px; flex:1; min-width:280px;">
          <input type="hidden" name="limit" value="<%= typeof limit !== 'undefined' ? limit : 10 %>">
          <input type="hidden" name="sort" value="<%= typeof sort !== 'undefined' ? sort : 'nama' %>">
          <input type="hidden" name="order" value="<%= typeof order !== 'undefined' ? order : 'asc' %>">
          <button type="submit">Cari</button>
          <a class="pill-link" href="/admin/guru">Reset</a>
        </form>
        <button type="button" id="bulkDeleteBtnHeader" class="pill-link" style="background:#b91c1c; color:#fff; border:none; display:none;">Hapus Dipilih</button>
      </div>
      <script>
        (function(){
          var sel = document.getElementById('limitSelectGuru');
          if (!sel) return;
          sel.addEventListener('change', function(){
            var params = new URLSearchParams(window.location.search);
            params.set('limit', this.value);
            params.set('page', '1');
            var url = window.location.pathname + '?' + params.toString();
            window.location.href = url;
          });
        })();
        (function(){
          var toggleBtn = document.getElementById('toggleGuruFormBtn');
          var modal = document.getElementById('guruModal');
          if (toggleBtn && modal) {
            toggleBtn.addEventListener('click', function(){
              modal.classList.remove('hidden');
              modal.setAttribute('aria-hidden','false');
              var nm = document.getElementById('guruNama');
              if (nm) setTimeout(function(){ nm.focus(); }, 30);
            });
            modal.querySelectorAll('[data-modal-close]').forEach(function(el){
              el.addEventListener('click', function(ev){
                ev.preventDefault();
                modal.classList.add('hidden');
                modal.setAttribute('aria-hidden','true');
              });
            });
            modal.addEventListener('click', function(e){
              var dlg = document.querySelector('.modal-dialog-guru .card');
              if (!dlg) return;
              if (!dlg.contains(e.target)) {
                modal.classList.add('hidden');
                modal.setAttribute('aria-hidden','true');
              }
            });
          }
        })();
      </script>

      
      <table class="table-realtime">
        <thead>
          <tr>
            <th style="width:36px;"><input type="checkbox" id="selectAll"></th>
            <th>No</th>
            <th>
              <a href="?sort=nama&order=<%= (typeof sort !== 'undefined' && sort==='nama' && order==='asc') ? 'desc' : 'asc' %>&limit=<%= typeof limit !== 'undefined' ? limit : 10 %><%= (typeof q !== 'undefined' && q) ? '&q=' + encodeURIComponent(q) : '' %>">Nama Guru</a>
            </th>
            <th>Pengampu Mapel</th>
            <th>
              <a href="?sort=totalMapel&order=<%= (typeof sort !== 'undefined' && sort==='totalMapel' && order==='asc') ? 'desc' : 'asc' %>&limit=<%= typeof limit !== 'undefined' ? limit : 10 %><%= (typeof q !== 'undefined' && q) ? '&q=' + encodeURIComponent(q) : '' %>">Total Mapel</a>
            </th>
            <th>
              <a href="?sort=totalJam&order=<%= (typeof sort !== 'undefined' && sort==='totalJam' && order==='asc') ? 'desc' : 'asc' %>&limit=<%= typeof limit !== 'undefined' ? limit : 10 %><%= (typeof q !== 'undefined' && q) ? '&q=' + encodeURIComponent(q) : '' %>">Total Jam</a>
            </th>
            <th>Link Upload</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody>
          <% guru.forEach((g, i) => { %>
            <tr>
              <td><input type="checkbox" name="ids[]" value="<%= g.id %>" class="row-check"></td>
              <td><%= typeof g.no !== 'undefined' ? g.no : (i + 1) %></td>
              <td><%= g.nama %></td>
              <td><%= g.pengampu || '-' %></td>
              <td><%= g.totalMapel %></td>
              <td><%= g.totalJam %> jam</td>
              <td>
                <a href="<%= g.uploadLink %>" target="_blank"><%= g.uploadLink %></a>
              </td>
              <td>
                <div class="action-menu" style="display:flex; flex-direction:column; gap:4px;">
                  <div class="icon-row" style="display:flex; gap:6px; flex-wrap:nowrap;">
                    <button type="button" class="icon-btn icon-green action-copy" title="Salin link upload" aria-label="Salin" data-link="<%= g.uploadLink %>">ðŸ“‹</button>
                    <form method="post" action="/admin/guru/reset-token/<%= g.id %>" onsubmit="return confirm('Reset token upload untuk <%= g.nama %>?')" style="display:inline-flex;">
                      <button type="submit" class="icon-btn icon-gray" title="Reset Token" aria-label="Reset Token">â†»</button>
                    </form>
                  </div>
                  <div class="icon-row" style="display:flex; gap:6px; flex-wrap:nowrap;">
                    <button type="button" class="icon-btn icon-blue btn-edit" title="Edit" aria-label="Edit" data-id="<%= g.id %>" data-nama="<%= g.nama %>" data-email="<%= g.email || '' %>">âœŽ</button>
                    <form method="post" action="/admin/guru/delete/<%= g.id %>" onsubmit="return confirm('Hapus guru <%= g.nama %>?')" style="display:inline-flex;">
                      <button type="submit" class="icon-btn icon-red" title="Hapus" aria-label="Hapus">ðŸ—‘</button>
                    </form>
                  </div>
                </div>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
      <!-- Form terpisah untuk Hapus Massal (disembunyikan) -->
      <form id="bulkDeleteForm" method="post" action="/admin/guru/bulk-delete" style="display:none;"></form>

      <% if (typeof page !== 'undefined' && typeof totalPages !== 'undefined') { %>
        <div style="margin-top:12px; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <% const startItem = (typeof totalRows !== 'undefined' && totalRows === 0) ? 0 : (((typeof page !== 'undefined' ? page : 1) - 1) * (typeof limit !== 'undefined' ? limit : 10)) + 1; %>
          <% const endItem = (typeof totalRows !== 'undefined' ? Math.min(startItem + (typeof limit !== 'undefined' ? limit : 10) - 1, totalRows) : startItem); %>
          <span style="color:#4b5563;">Menampilkan <%= startItem %>â€“<%= endItem %> dari <%= typeof totalRows !== 'undefined' ? totalRows : guru.length %> guru</span>
        </div>
      <% } %>
         <script>
          document.querySelectorAll('.action-copy').forEach(btn => {
            btn.addEventListener('click', async () => {
              const text = btn.getAttribute('data-link');
              try {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                  await navigator.clipboard.writeText(text);
                  btn.textContent = 'âœ”';
                  setTimeout(() => btn.textContent = 'ðŸ“‹', 1200);
                } else {
                  const ta = document.createElement('textarea');
                  ta.value = text;
                  document.body.appendChild(ta);
                  ta.select();
                  document.execCommand('copy');
                  document.body.removeChild(ta);
                  btn.textContent = 'âœ”';
                  setTimeout(() => btn.textContent = 'ðŸ“‹', 1200);
                }
              } catch (e) {
                alert('Gagal menyalin: ' + e.message);
              }
            });
          });
        </script>
        <script>
          (function(){
            var selectAll = document.getElementById('selectAll');
            var bulkBtn = document.getElementById('bulkDeleteBtnHeader');
            function anyChecked(){
              return Array.from(document.querySelectorAll('.row-check')).some(function(cb){ return cb.checked; });
            }
            function updateVisibility(){
              if (bulkBtn) bulkBtn.style.display = anyChecked() ? 'inline-block' : 'none';
            }
            if (selectAll) {
              selectAll.addEventListener('change', function(){
                document.querySelectorAll('.row-check').forEach(function(cb){ cb.checked = selectAll.checked; });
                updateVisibility();
              });
            }
            document.querySelectorAll('.row-check').forEach(function(cb){
              cb.addEventListener('change', updateVisibility);
            });
            if (bulkBtn) {
              bulkBtn.addEventListener('click', function(){
                if (!anyChecked()) return;
                if (!confirm('Hapus semua data guru yang dipilih?')) return;
                var form = document.getElementById('bulkDeleteForm');
                if (form) {
                  // Bersihkan input sebelumnya
                  while (form.firstChild) form.removeChild(form.firstChild);
                  // Tambahkan ids[] dari checkbox terpilih
                  document.querySelectorAll('.row-check:checked').forEach(function(cb){
                    var inp = document.createElement('input');
                    inp.type = 'hidden'; inp.name = 'ids[]'; inp.value = cb.value;
                    form.appendChild(inp);
                  });
                  form.submit();
                }
              });
            }
            updateVisibility();
          })();
        </script>
        <!-- Modal Edit Guru -->
        <div id="editModal" style="position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:9999;">
          <div style="background:#fff; border-radius:10px; padding:16px; width:100%; max-width:420px; box-shadow:0 12px 24px rgba(0,0,0,.2);">
            <h3 style="margin:0 0 10px; color:#1f2937;">Edit Guru</h3>
            <form id="editForm" method="post" action="">
              <label style="display:block; margin-bottom:8px; color:#374151; font-weight:600;">Nama
                <input type="text" name="nama" id="editNama" required style="width:100%; padding:8px 10px; border:1px solid #d1d5db; border-radius:6px;">
              </label>
              <label style="display:block; margin-bottom:12px; color:#374151; font-weight:600;">Email (opsional)
                <input type="email" name="email" id="editEmail" style="width:100%; padding:8px 10px; border:1px solid #d1d5db; border-radius:6px;">
              </label>
              <div style="display:flex; gap:8px; justify-content:flex-end;">
                <button type="button" id="editCancel" class="pill-link" style="background:#6b7280; color:#fff; border:none;">Batal</button>
                <button type="submit" class="pill-link" style="background:#2563eb; color:#fff; border:none;">Simpan</button>
              </div>
            </form>
          </div>
        </div>
        <script>
          (function(){
            var modal = document.getElementById('editModal');
            var form = document.getElementById('editForm');
            var namaInput = document.getElementById('editNama');
            var emailInput = document.getElementById('editEmail');
            function openModal(id, nama, email){
              form.action = '/admin/guru/edit/' + id;
              namaInput.value = nama || '';
              emailInput.value = email || '';
              modal.style.display = 'flex';
              setTimeout(function(){ namaInput.focus(); }, 60);
            }
            function closeModal(){ modal.style.display = 'none'; }
            document.querySelectorAll('.btn-edit').forEach(function(btn){
              btn.addEventListener('click', function(){
                openModal(this.dataset.id, this.dataset.nama, this.dataset.email);
              });
            });
            document.getElementById('editCancel').addEventListener('click', closeModal);
            modal.addEventListener('click', function(e){ if (e.target === modal) closeModal(); });
            document.addEventListener('keydown', function(e){ if (e.key === 'Escape' && modal.style.display === 'flex') closeModal(); });
          })();
        </script>
    </main>
  </div>
</body></html>