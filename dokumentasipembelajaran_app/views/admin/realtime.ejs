<!DOCTYPE html>
<html lang="id"><head><meta charset="UTF-8"><title>Pemantauan Realtime</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/assets/admin.css">
  <script src="/assets/admin.js" defer></script>
</head>
<body class="dashboard-simple">
  <div class="layout">
    <%- include('_sidebar') %>
    <main class="content">
      <div class="main-top" style="display:flex; align-items:center; justify-content:space-between;">
        <span id="liveTime" style="font-weight:600;"></span>
        <a class="pill-link" href="/admin/logout">Keluar</a>
      </div>
      <h2>Pemantauan Realtime (Hari Ini)</h2>
      <div class="auto-refresh-bar" style="display:flex; align-items:center; gap:8px; margin:6px 0 10px;">
        <span class="muted">Auto refresh: 20 detik</span>
        <button type="button" id="toggleAutoRefresh" class="pill-link">Matikan</button>
      </div>
      <form method="get" class="header-actions" style="display:flex; gap:8px; align-items:center; margin:10px 0 14px;">
        <input type="text" name="q" value="<%= q || '' %>" placeholder="Cari nama/mapel/kelas" style="padding:8px 10px; border:1px solid #d1d5db; border-radius:6px; flex:1; min-width:280px;">
        <select name="limit" style="padding:8px 10px; border:1px solid #d1d5db; border-radius:6px;">
          <option value="10" <%= String(limit)==='10' ? 'selected' : '' %>>10</option>
          <option value="50" <%= String(limit)==='50' ? 'selected' : '' %>>50</option>
          <option value="100" <%= String(limit)==='100' ? 'selected' : '' %>>100</option>
          <option value="1000" <%= String(limit)==='1000' ? 'selected' : '' %>>1000</option>
        </select>
        <input type="hidden" name="sort" value="<%= sort %>">
        <input type="hidden" name="order" value="<%= order %>">
        <button type="submit">Cari</button>
        <a class="pill-link" href="/admin/realtime">Reset</a>
        <span class="muted" style="margin-left:8px;">Urut:</span>
        <a class="pill-link" href="?page=1&limit=<%= limit %>&sort=nama&order=asc<%= q ? '&q=' + encodeURIComponent(q) : '' %>">Nama</a>
        <a class="pill-link" href="?page=1&limit=<%= limit %>&sort=terbaru&order=desc<%= q ? '&q=' + encodeURIComponent(q) : '' %>">Terbaru</a>
      </form>
      <div class="subtabs" style="display:flex; gap:8px; margin:6px 0 8px;">
        <a href="#" id="btnTabMain" class="pill-link active">Jadwal Hari Ini</a>
        <a href="#" id="btnTabInvalid" class="pill-link">Kiriman Tidak Sesuai</a>
      </div>
      <div class="print-actions" style="display:flex; gap:8px; margin:4px 0 12px;">
        <a class="pill-link" href="/admin/realtime/print-invalid" target="_blank" rel="noopener">Print Rekap Invalid (A4 Landscape)</a>
        <a class="pill-link" href="/admin/realtime/print-valid" target="_blank" rel="noopener">Print Rekap Valid (A4 Landscape)</a>
      </div>
      <section id="tabMain">
      <table id="table-main" class="table-realtime table-sortable">
        <thead>
          <tr>
            <th>No</th>
            <th data-sort-key="nama" <%= sort === 'nama' ? ('data-sort="' + order + '"') : '' %>>Nama Guru</th>
            <th data-sort-key="mapel" <%= sort === 'mapel' ? ('data-sort="' + order + '"') : '' %>>Kode Mapel</th>
            <th data-sort-key="kelas" <%= sort === 'kelas' ? ('data-sort="' + order + '"') : '' %>>Kelas</th>
            <th data-sort-key="jamKe" <%= sort === 'jamKe' ? ('data-sort="' + order + '"') : '' %>>Jam Ke</th>
            <th data-sort-key="status" <%= sort === 'status' ? ('data-sort="' + order + '"') : '' %>>Status Pengiriman Foto</th>
            <th data-sort-key="terbaru" <%= sort === 'terbaru' ? ('data-sort="' + order + '"') : '' %>>Waktu Pengiriman</th>
            <th>Lokasi Maps</th>
            <th>Foto Mengajar</th>
          </tr>
        </thead>
        <tbody>
          <% rows.forEach(r => { %>
            <tr>
              <td><%= r.no %></td>
              <td><%= r.nama %></td>
              <td><%= r.mapel %></td>
              <td><%= r.kelas %></td>
              <td><%= r.jamKe %></td>
              <td><%= r.status %><% if (r.statusDetail) { %> — <span class="muted"><%= r.statusDetail %></span><% } %></td>
              <td>
                <% if (r.waktuKirim) { %>
                  <%= new Date(r.waktuKirim).toLocaleTimeString('id-ID',{ hour: '2-digit', minute: '2-digit', second: '2-digit' }) %>
                <% } else { %>
                  —
                <% } %>
              </td>
              <td>
                <% if (r.lokasiValid === true) { %><span class="badge badge-valid">Valid</span><% } else if (r.lokasiValid === false) { %><span class="badge badge-invalid">Tidak Valid</span><% } else { %><span class="badge badge-muted">—</span><% } %>
                <% if (r.mapsUrl) { %>
                  <a href="<%= r.mapsUrl %>" class="icon-map" target="_blank" rel="noopener" aria-label="Buka di Google Maps" title="Koordinat: <%= (r.latitude!=null && r.longitude!=null) ? (r.latitude + ', ' + r.longitude) : 'Google Maps' %>">
                    <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
                      <path fill="currentColor" d="M12 2C8.686 2 6 4.686 6 8c0 5.25 6 12 6 12s6-6.75 6-12c0-3.314-2.686-6-6-6zm0 8.5a2.5 2.5 0 110-5 2.5 2.5 0 010 5z"/>
                    </svg>
                  </a>
                <% } %>
              </td>
              <td class="td-foto">
                <% if (r.fotoUrl) { %>
                  <img class="photo-thumb" src="<%= r.fotoUrl %>" alt="Foto Mengajar" style="max-width:100px; height:auto; border-radius:4px; cursor: zoom-in;" />
                <% } else { %>
                  —
                <% } %>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>

      <script>
        (function() {
          const table = document.getElementById('table-main');
          if (!table) return;
          const url = new URL(window.location.href);
          const currentSort = url.searchParams.get('sort');
          const currentOrder = url.searchParams.get('order') || 'asc';

          table.querySelectorAll('thead th[data-sort-key]').forEach(th => {
            th.style.cursor = 'pointer';
            th.addEventListener('click', () => {
              const key = th.getAttribute('data-sort-key');
              const isSameKey = currentSort === key;
              const nextOrder = isSameKey && currentOrder === 'asc' ? 'desc' : 'asc';
              url.searchParams.set('sort', key);
              url.searchParams.set('order', nextOrder);
              url.searchParams.set('page', '1');
              window.location.href = url.toString();
            });
          });
        })();
      </script>


      <!-- Overlay untuk perbesar foto (klik 2x) -->
      <div id="photoOverlay" class="photo-overlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.75); align-items:center; justify-content:center; z-index:1000;">
        <img id="photoOverlayImg" src="" alt="Foto Mengajar" style="max-width:90vw; max-height:90vh; border-radius:8px; box-shadow:0 10px 28px rgba(0,0,0,0.4);" />
      </div>

      <div class="pagination" style="margin-top:12px;">
        <a class="<%= page === 1 ? 'disabled' : '' %>" href="?page=<%= Math.max(1, page - 1) %>&limit=<%= limit %>&sort=<%= sort %>&order=<%= order %><%= q ? '&q=' + encodeURIComponent(q) : '' %>">Prev</a>
        <% const maxPage = totalPages; const pagesToShow = Math.min(7, maxPage); let startPage = Math.max(1, page - Math.floor(pagesToShow/2)); if (startPage + pagesToShow - 1 > maxPage) startPage = Math.max(1, maxPage - pagesToShow + 1); %>
        <% for (let p = startPage; p <= Math.min(maxPage, startPage + pagesToShow - 1); p++) { %>
          <a class="<%= (p === page) ? 'active' : '' %>" href="?page=<%= p %>&limit=<%= limit %>&sort=<%= sort %>&order=<%= order %><%= q ? '&q=' + encodeURIComponent(q) : '' %>"><%= p %></a>
        <% } %>
        <a class="<%= page >= totalPages ? 'disabled' : '' %>" href="?page=<%= Math.min(totalPages, page + 1) %>&limit=<%= limit %>&sort=<%= sort %>&order=<%= order %><%= q ? '&q=' + encodeURIComponent(q) : '' %>">Next</a>
      </div>
      </section>

      <section id="tabInvalid" style="display:none;">
      <h3 style="margin:16px 0 8px;">Kiriman Tidak Sesuai (Hari Ini) <span class="muted">(<%= invalidCount || 0 %>)</span></h3>
      <table class="table-realtime table-sortable" id="table-invalids">
        <thead>
          <tr>
            <th>No</th>
            <th>Nama Guru</th>
            <th>Kode Mapel</th>
            <th>Kelas</th>
            <th>Jam Dikirim</th>
            <th>Waktu Pengiriman</th>
            <th>Lokasi Maps</th>
            <th>Alasan</th>
            <th>Foto</th>
          </tr>
        </thead>
        <tbody>
          <% if (invalids && invalids.length) { invalids.forEach((x, i) => { %>
            <tr>
              <td><%= i + 1 %></td>
              <td><%= x.guru %></td>
              <td><%= x.mapel %></td>
              <td><%= x.kelas %></td>
              <td><%= x.jamDikirim %></td>
              <td>
                <% const wpk = x.waktuKirim || x.waktu; %>
                <% if (wpk) { %>
                  <%= new Date(wpk).toLocaleTimeString('id-ID',{ hour: '2-digit', minute: '2-digit', second: '2-digit' }) %>
                <% } else { %>—<% } %>
              </td>
              <td>
                <% if (x.lokasiValid === true) { %><span class="badge badge-valid">Valid</span><% } else if (x.lokasiValid === false) { %><span class="badge badge-invalid">Tidak Valid</span><% } else { %><span class="badge badge-muted">—</span><% } %>
                <% if (x.mapsUrl) { %>
                  <a href="<%= x.mapsUrl %>" class="icon-map" target="_blank" rel="noopener" aria-label="Buka di Google Maps" title="Koordinat: <%= (x.latitude!=null && x.longitude!=null) ? (x.latitude + ', ' + x.longitude) : 'Google Maps' %>">
                    <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
                      <path fill="currentColor" d="M12 2C8.686 2 6 4.686 6 8c0 5.25 6 12 6 12s6-6.75 6-12c0-3.314-2.686-6-6-6zm0 8.5a2.5 2.5 0 110-5 2.5 2.5 0 010 5z"/>
                    </svg>
                  </a>
                <% } %>
              </td>
              <td><span class="muted"><%= x.alasan %></span></td>
              <td class="td-foto">
                <% if (x.fotoUrl) { %>
                  <img class="photo-thumb" src="<%= x.fotoUrl %>" alt="Foto Kiriman" style="max-width:100px; height:auto; border-radius:4px; cursor: zoom-in;" />
                <% } else { %>
                  —
                <% } %>
              </td>
            </tr>
          <% }) } else { %>
            <tr><td colspan="7" class="muted">Tidak ada kiriman yang tidak sesuai.</td></tr>
          <% } %>
        </tbody>
      </table>
      </section>

      <style>
        .badge { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; line-height:18px; font-weight:600; }
        .badge-valid { background:#dcfce7; color:#166534; border:1px solid #86efac; }
        .badge-invalid { background:#fee2e2; color:#991b1b; border:1px solid #fecaca; }
        .badge-muted { background:#eef2ff; color:#1f2937; border:1px solid #e5e7eb; }

        .icon-map { display:inline-flex; align-items:center; justify-content:center; width:22px; height:22px; margin-left:6px; color:#2563eb; }
        .icon-map svg { display:block; fill:currentColor; }
        .icon-map:hover { color:#1d4ed8; }

        .table-sortable thead th { cursor:pointer; user-select:none; }
        .table-sortable thead th[data-sort="asc"]::after { content:" \25B2"; color:#64748b; }
        .table-sortable thead th[data-sort="desc"]::after { content:" \25BC"; color:#64748b; }

        .pagination { margin-top:8px; display:flex; gap:6px; align-items:center; flex-wrap:wrap; }
        .pagination a, .pagination button { padding:4px 8px; border:1px solid #d1d5db; background:#fff; color:#111827; border-radius:6px; cursor:pointer; text-decoration:none; }
        .pagination a.active, .pagination button.active { background:#2563eb; color:#fff; border-color:#2563eb; }
        .pagination a.disabled, .pagination button:disabled { opacity:.5; cursor:not-allowed; pointer-events:none; }
      </style>

      <script>
        (function(){
          const REFRESH_MS = 20000; // 20 detik
          const url = new URL(window.location.href);
          const autoParam = String(url.searchParams.get('auto') || '').toLowerCase();
          // Matikan auto refresh saat preview IDE (memiliki ide_webview_request_time) atau jika ?auto=off
          let paused = url.searchParams.has('ide_webview_request_time') || autoParam === 'off';
          let timer;
          const btn = document.getElementById('toggleAutoRefresh');
          function schedule(){
            clearTimeout(timer);
            timer = setTimeout(() => { if (!paused) location.reload(); }, REFRESH_MS);
          }
          if (btn) {
            btn.textContent = paused ? 'Nyalakan' : 'Matikan';
            btn.addEventListener('click', () => {
              paused = !paused;
              btn.textContent = paused ? 'Nyalakan' : 'Matikan';
              schedule();
            });
          }
          schedule();
        })();

        // Fitur perbesar foto: klik 2x pada gambar, klik 1x di luar untuk menutup
        (function(){
          const overlay = document.getElementById('photoOverlay');
          const overlayImg = document.getElementById('photoOverlayImg');
          const thumbs = document.querySelectorAll('img.photo-thumb');
          thumbs.forEach((img) => {
            img.addEventListener('dblclick', () => {
              overlayImg.src = img.src;
              overlay.style.display = 'flex';
            });
          });
          overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
              overlay.style.display = 'none';
              overlayImg.src = '';
            }
          });
        })();
        (function(){
          const btnMain = document.getElementById('btnTabMain');
          const btnInvalid = document.getElementById('btnTabInvalid');
          const tabMain = document.getElementById('tabMain');
          const tabInvalid = document.getElementById('tabInvalid');
          function show(which){
            if (!tabMain || !tabInvalid || !btnMain || !btnInvalid) return;
            // Simpan tab aktif agar bertahan saat auto-refresh/reload
            try { localStorage.setItem('realtimeActiveTab', which); } catch(e) {}
            if (which === 'invalid') {
              tabMain.style.display = 'none';
              tabInvalid.style.display = 'block';
              btnMain.classList.remove('active');
              btnInvalid.classList.add('active');
            } else {
              tabMain.style.display = 'block';
              tabInvalid.style.display = 'none';
              btnMain.classList.add('active');
              btnInvalid.classList.remove('active');
            }
          }
          if (btnMain && btnInvalid) {
            btnMain.addEventListener('click', (e) => { e.preventDefault(); show('main'); });
            btnInvalid.addEventListener('click', (e) => { e.preventDefault(); show('invalid'); });
            // Restore tab aktif dari localStorage; default ke 'main'
            let stored = null;
            try { stored = localStorage.getItem('realtimeActiveTab'); } catch(e) { stored = null; }
            show(stored === 'invalid' ? 'invalid' : 'main');
          }
        })();
        // Sorting & Pagination untuk tabel invalids
        (function(){
          const table = document.getElementById('table-invalids');
          if (!table) return;
          const PAGING_SIZE = 20;
          const pager = document.createElement('div');
          pager.id = 'pagination-invalids';
          pager.className = 'pagination';
          table.after(pager);

          function applyPagination(current){
            const rows = Array.from(table.tBodies[0].rows);
            const total = rows.length;
            const pages = Math.max(1, Math.ceil(total / PAGING_SIZE));
            const start = (current-1)*PAGING_SIZE;
            const end = current*PAGING_SIZE;
            rows.forEach((row, idx) => {
              row.style.display = (idx >= start && idx < end) ? '' : 'none';
            });
            pager.innerHTML = '';
            const prev = document.createElement('button');
            prev.textContent = 'Prev';
            prev.disabled = current === 1;
            prev.addEventListener('click', () => { table.dataset.page = String(current - 1); applyPagination(current - 1); });
            pager.appendChild(prev);
            const maxPage = Math.max(1, Math.ceil(total / PAGING_SIZE));
            const pagesToShow = Math.min(7, maxPage);
            let startPage = Math.max(1, current - Math.floor(pagesToShow/2));
            if (startPage + pagesToShow - 1 > maxPage) startPage = Math.max(1, maxPage - pagesToShow + 1);
            for (let p = startPage; p <= Math.min(maxPage, startPage + pagesToShow -1); p++) {
              const btn = document.createElement('button');
              btn.textContent = String(p);
              if (p === current) btn.classList.add('active');
              btn.addEventListener('click', () => { table.dataset.page = String(p); applyPagination(p); });
              pager.appendChild(btn);
            }
            const next = document.createElement('button');
            next.textContent = 'Next';
            next.disabled = current >= maxPage;
            next.addEventListener('click', () => { table.dataset.page = String(current + 1); applyPagination(current + 1); });
            pager.appendChild(next);
          }

          function sortByColumn(columnIndex) {
            const tbody = table.tBodies[0];
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const th = table.tHead.rows[0].cells[columnIndex];
            const current = th.getAttribute('data-sort') || 'none';
            const newDir = current === 'asc' ? 'desc' : 'asc';
            Array.from(table.tHead.rows[0].cells).forEach(c => c.removeAttribute('data-sort'));
            th.setAttribute('data-sort', newDir);
            rows.sort((a,b) => {
              const aText = a.cells[columnIndex]?.textContent.trim() || '';
              const bText = b.cells[columnIndex]?.textContent.trim() || '';
              const aNum = parseFloat(aText.replace(/[^\d.-]/g,''));
              const bNum = parseFloat(bText.replace(/[^\d.-]/g,''));
              const bothNumeric = !isNaN(aNum) && !isNaN(bNum) && /^\d/.test(aText) && /^\d/.test(bText);
              const cmp = bothNumeric ? (aNum - bNum) : aText.localeCompare(bText, 'id', { numeric: true, sensitivity: 'base' });
              return newDir === 'asc' ? cmp : -cmp;
            });
            rows.forEach(r => tbody.appendChild(r));
            applyPagination(parseInt(table.dataset.page || '1', 10));
          }

          Array.from(table.tHead.rows[0].cells).forEach((th, idx) => {
            th.classList.add('th-sortable');
            th.addEventListener('click', () => sortByColumn(idx));
          });

          table.dataset.page = '1';
          applyPagination(1);
        })();
      </script>
    </main>
  </div>
</body></html>